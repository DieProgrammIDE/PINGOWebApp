// This view is rendered when a survey is requested via Ajax on an event page.

view_url = "<%= event_survey_path(@survey.event, @survey) %>";
event_page = true;

$('tr.info').removeClass("info");
$('tr#row<%= @survey.id %>').addClass("info");

$('#survey-container').slideDown().html("<%= escape_javascript(render partial: 'show', locals: {:survey => @survey} ) %>");

window.PINGO.Init();

$('#survey_name').on('update', function() {
	$('#name-<%= @survey.id.to_s %>').text($(this).data('editable').value);
});

if(!History){
	var History = window.History;
}
if(History){
	History.pushState(null, "<%= @survey.name||"Umfrage" %> [<%= @survey.event.token %>] - PINGO", "<%= event_survey_path(@survey.event, @survey)%>");

	// Inform Google Analytics of the change
	if(typeof ga !== 'undefined'){
    ga("send", "pageview", "<%= event_survey_path(@survey.event, @survey)%>");
	}
}

setVoterCount(<%= @survey.total_votes %>, "<%= @survey.id.to_s %>");

<% if @survey.running?(true) && @survey.ends %>

	startCountdown(<%= @survey.time_left(true)-1000 %>);

	<%= render partial: "show_push" %>

<% end %>

<% if @survey.starts && @survey.starts <= DateTime.now %>

// Draw Chart
<%= render partial: "chart", locals: {:survey => @survey, :selector => "#chart"} %>

<% # TODO  chart only if choice question
%>

<% end %>

// scroll into view (we scroll to h1 since there's a 60px bootstrap menu bar)

$('#survey-container').imagesLoaded(function() {
	$('.container-centered h1').get(0).scrollIntoView(true);
});

if(MathJax !== undefined) {
	MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
}
